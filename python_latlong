import csv,os
from pyproj import Proj, CRS, transform, Transformer

# Define the input and output file paths
input_csv = 'PointHeatCO2Rich.csv'
output_csv = 'LatLongPoints.csv'

# Define the CRS (Coordinate Reference Systems)
proj_osgb36 = CRS.from_epsg(27700)  # OSGB36 (British National Grid)
proj_wgs84 = CRS.from_epsg(4326)  # WGS84 (latitude/longitude)

# Create a Transformer object for converting OSGB36 (Easting/Northing) to WGS84 (Latitude/Longitude)
transformer = Transformer.from_crs(proj_osgb36, proj_wgs84, always_xy=True)

# Open the input CSV file and read Easting/Northing
with open(input_csv, mode='r') as infile, open(output_csv, mode='w', newline='') as outfile:
    reader = csv.reader(infile)
    writer = csv.writer(outfile)

    # Try to read the header, handle empty file cases
    try:
        header = next(reader)
    except StopIteration:
        print("Error: The input CSV file is empty or missing a header row.")
        exit(1)

    # Write the header and append 'Latitude' and 'Longitude' columns
    writer.writerow(header + ['Latitude', 'Longitude'])

    # Process each row in the CSV
    for row in reader:
        # Extract the Easting and Northing from the 2nd and 3rd columns
        easting = float(row[1])  # Assuming 2nd column is Easting
        northing = float(row[2])  # Assuming 3rd column is Northing

        # Convert Easting/Northing (OSGB36) to Latitude/Longitude (WGS84)
        longitude, latitude = transformer.transform(easting, northing)

        # Write the row, appending the calculated Latitude and Longitude
        writer.writerow(row + [latitude, longitude])

print(f"Conversion complete. Output saved to {output_csv}")